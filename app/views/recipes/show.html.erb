<% content_for(:title) { @recipe.title } %>

<div class="window">
    <div class="title-bar">
        <button aria-label="Close" class="close"></button>
        <h1 class="title"><%= @recipe.title || "(Untitled Recipe)" %></h1>
        <button aria-label="Resize" class="resize"></button>
    </div>

    <div class="details-bar">
        <span><%= link_to @source.title.truncate(40), source_path(@source) %></span>
        <span>·</span>
        <span><%= @source.author || "Unknown" %></span>
        <span>·</span>
        <span><%= @source.publication_year || "?" %></span>
    </div>

    <div class="separator"></div>

    <%# Recipe metadata %>
    <div class="window-pane">
        <dl class="meta-grid">
            <dt>Source</dt>
            <dd><%= link_to @source.title, source_path(@source) %></dd>

            <% if @recipe.cook_time.present? || @recipe.prep_time.present? || @recipe.ready_in_minutes.present? %>
            <dt>Time</dt>
            <dd>
                <div class="time-info">
                    <% if @recipe.prep_time.present? %>
                    <span>Prep: <%= @recipe.prep_time %> min</span>
                    <% end %>
                    <% if @recipe.cook_time.present? %>
                    <span>Cook: <%= @recipe.cook_time %> min</span>
                    <% end %>
                    <% if @recipe.ready_in_minutes.present? %>
                    <span>Total: <%= @recipe.ready_in_minutes %> min</span>
                    <% end %>
                </div>
            </dd>
            <% end %>

            <% if @recipe.yield_amount.present? %>
            <dt>Yield</dt>
            <dd><%= @recipe.yield_amount %><%= " – #{@recipe.yield_amount_max}" if @recipe.yield_amount_max.present? %> <%= @recipe.yield_unit %></dd>
            <% end %>

            <dt>Status</dt>
            <dd>
                <span class="badge badge-<%= @recipe.extraction_status == 'success' ? 'success' : 'failed' %>">
                    <%= @recipe.extraction_status %>
                </span>
                <% if @recipe.extracted_at.present? %>
                · extracted <%= time_ago_in_words(@recipe.extracted_at) %> ago
                <% end %>
                <% if @recipe.extraction_status == 'failed' && @recipe.input_text.present? %>
                <%= button_to "Retry extraction", retry_extraction_source_recipe_path(@source, @recipe), method: :post, class: "btn btn-small" %>
                <% end %>
                <% if @recipe.input_text.present? %>
                <%= button_to "Split & re-extract", split_and_reextract_source_recipe_path(@source, @recipe), method: :post, class: "btn btn-small", data: { confirm: "This will split the input text into separate recipes and mark this one as not-a-recipe. Continue?" } %>
                <% end %>
            </dd>

            <dt>Not a recipe</dt>
            <dd>
                <%= form_with model: [@source, @recipe], url: source_recipe_path(@source, @recipe), method: :patch, local: true do |f| %>
                <%= f.check_box :not_a_recipe, { onchange: "this.form.submit()" }, true, false %>
                <%= f.label :not_a_recipe, "Mark as not a recipe" %>
                <% end %>
            </dd>
        </dl>
    </div>

    <%# Ingredients section %>
    <div class="separator"></div>
    <div class="section-header">Ingredients (<%= @recipe.ingredients.count %>)</div>

    <% if @recipe.ingredient_groups.any? %>
    <% @recipe.ingredient_groups.order(:order).each do |group| %>
    <% if group.name.present? %>
    <div class="group-name"><%= group.name %></div>
    <% end %>

    <ul class="ingredient-list">
        <% group.ingredients.order(:order).each do |ingredient| %>
        <li>
            <%= highlight_product(ingredient.original_string, ingredient.product) %>
            <% if ingredient.foundation_food_name.present? %>
            <span class="foundation-food">
                ↝ <%= ingredient.foundation_food_name %>
                <% if ingredient.foundation_food_category.present? %>
                [<%= ingredient.foundation_food_category %>]
                <% end %>
            </span>
            <% end %>
        </li>
        <% end %>
    </ul>
    <% end %>
    <% else %>
    <div class="window-pane">
        <div class="empty-state">No ingredients extracted.</div>
    </div>
    <% end %>

    <%# Instructions section %>
    <div class="separator"></div>
    <div class="section-header">Instructions (<%= @recipe.instructions.count %>)</div>

    <div class="window-pane">
        <% if @recipe.instruction_groups.any? %>
        <% @recipe.instruction_groups.order(:order).each do |group| %>
        <% if group.name.present? %>
        <div class="group-name"><%= group.name %></div>
        <% end %>

        <ol class="instruction-list">
            <% group.instructions.order(:order).each do |instruction| %>
            <li><%= instruction.step %></li>
            <% end %>
        </ol>
        <% end %>
        <% else %>
        <div class="empty-state">No instructions extracted.</div>
        <% end %>
    </div>

    <%# Original text section (editable) %>
    <div class="separator"></div>
    <div class="section-header">
        Original Text
        <% if @recipe.input_text_edited_at.present? %>
        <span class="muted">· last edited <%= time_ago_in_words(@recipe.input_text_edited_at) %> ago</span>
        <% end %>
    </div>
    <div class="window-pane">
        <%= form_with model: [@source, @recipe], url: source_recipe_path(@source, @recipe), method: :patch, local: true do |f| %>
        <%= f.text_area :input_text, class: "original-text-input", rows: 12, placeholder: "Paste or edit the original recipe text here…" %>
        <%= f.submit "Save original text", class: "btn btn-small" %>
        <% end %>
    </div>

    <%# Notes section (editable) %>
    <div class="separator"></div>
    <div class="section-header">Notes</div>
    <div class="window-pane">
        <%= form_with model: [@source, @recipe], url: source_recipe_path(@source, @recipe), method: :patch, local: true do |f| %>
        <%= f.text_area :notes, class: "original-text-input notes-input", rows: 6, placeholder: "Add notes about this recipe…" %>
        <%= f.submit "Save notes", class: "btn btn-small" %>
        <% end %>
    </div>
</div>